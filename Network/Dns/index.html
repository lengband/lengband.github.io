<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>DNS | Lengband Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="即刻记录精彩">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.a2da8f38.js" as="script"><link rel="preload" href="/assets/js/2.d9c77588.js" as="script"><link rel="preload" href="/assets/js/21.cbdb3403.js" as="script"><link rel="prefetch" href="/assets/js/10.7bb7c324.js"><link rel="prefetch" href="/assets/js/11.48aafdf6.js"><link rel="prefetch" href="/assets/js/12.fe4beccc.js"><link rel="prefetch" href="/assets/js/13.a9830dd2.js"><link rel="prefetch" href="/assets/js/14.cc471259.js"><link rel="prefetch" href="/assets/js/15.80a888f9.js"><link rel="prefetch" href="/assets/js/16.9ef8bd1d.js"><link rel="prefetch" href="/assets/js/17.96a14a35.js"><link rel="prefetch" href="/assets/js/18.5b895c69.js"><link rel="prefetch" href="/assets/js/19.8a9d930e.js"><link rel="prefetch" href="/assets/js/20.06738571.js"><link rel="prefetch" href="/assets/js/22.c694d42d.js"><link rel="prefetch" href="/assets/js/23.dc693082.js"><link rel="prefetch" href="/assets/js/24.0ccf1229.js"><link rel="prefetch" href="/assets/js/25.1a2e3e5b.js"><link rel="prefetch" href="/assets/js/26.2bef024a.js"><link rel="prefetch" href="/assets/js/27.9ed68f2a.js"><link rel="prefetch" href="/assets/js/28.7d6e7e23.js"><link rel="prefetch" href="/assets/js/29.7bd115e9.js"><link rel="prefetch" href="/assets/js/3.dba46206.js"><link rel="prefetch" href="/assets/js/4.56bd36f2.js"><link rel="prefetch" href="/assets/js/5.0e979832.js"><link rel="prefetch" href="/assets/js/6.fb87b94e.js"><link rel="prefetch" href="/assets/js/7.73f2f48f.js"><link rel="prefetch" href="/assets/js/8.45fbd5fb.js"><link rel="prefetch" href="/assets/js/9.c26675c1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/hero.jpeg" alt="Lengband Blog" class="logo"> <span class="site-name can-hide">Lengband Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Fe/" class="nav-link">
  Web
</a></div><div class="nav-item"><a href="/Ops/" class="nav-link">
  Ops
</a></div><div class="nav-item"><a href="/Network/" class="nav-link router-link-active">
  Network
</a></div><div class="nav-item"><a href="/Thought/" class="nav-link">
  随笔
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Contact" class="dropdown-title"><span class="title">Contact</span> <span class="arrow down"></span></button> <button type="button" aria-label="Contact" class="mobile-dropdown-title"><span class="title">Contact</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/lengband" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Fe/" class="nav-link">
  Web
</a></div><div class="nav-item"><a href="/Ops/" class="nav-link">
  Ops
</a></div><div class="nav-item"><a href="/Network/" class="nav-link router-link-active">
  Network
</a></div><div class="nav-item"><a href="/Thought/" class="nav-link">
  随笔
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Contact" class="dropdown-title"><span class="title">Contact</span> <span class="arrow down"></span></button> <button type="button" aria-label="Contact" class="mobile-dropdown-title"><span class="title">Contact</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/lengband" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/Network/Http/" class="sidebar-link">透析HTTP协议</a></li><li><a href="/Network/Dns/" aria-current="page" class="active sidebar-link">Dns</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Network/Dns/#dns-核心结构" class="sidebar-link">DNS 核心结构</a></li><li class="sidebar-sub-header"><a href="/Network/Dns/#dns寻址" class="sidebar-link">DNS寻址</a></li><li class="sidebar-sub-header"><a href="/Network/Dns/#总结" class="sidebar-link">总结</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="dns-核心结构"><a href="#dns-核心结构" class="header-anchor">#</a> DNS 核心结构</h2> <p>DNS 的核心系统是一个三层的树状、分布式服务，基本对应域名的结构</p> <ol><li>根域名服务器（Root DNS Server）：管理顶级域名服务器，返回“com”“net”“cn”等顶级域名服务器的 IP 地址；</li> <li>顶级域名服务器（Top-level DNS Server）：管理各自域名下的权威域名服务器，比如 com 顶级域名服务器可以返回 apple.com 域名服务器的 IP 地址；</li> <li>权威域名服务器（Authoritative DNS Server）：管理自己域名下主机的 IP 地址，比如 apple.com 权威域名服务器可以返回 www.apple.com 的 IP 地址。</li></ol> <blockquote><p>在这里根域名服务器是关键，它必须是众所周知的，否则下面的各级服务器就无从谈起了。目前全世界共有 13 组根域名服务器，又有数百台的镜像，保证一定能够被访问到。</p></blockquote> <p><img src="https://static001.geekbang.org/resource/image/6b/f2/6b020454987543efdd1cf6ddec784bf2.png" alt=""></p> <p>例如，你要访问“www.apple.com”，就要进行下面的三次查询：访问根域名服务器，它会告诉你“com”顶级域名服务器的地址；访问“com”顶级域名服务器，它再告诉你“apple.com”域名服务器的地址；最后访问“apple.com”域名服务器，就得到了“www.apple.com”的地址。</p> <p>虽然核心的 DNS 系统遍布全球，服务能力很强也很稳定，但如果全世界的网民都往这个系统里挤，即使不挤瘫痪了，访问速度也会很慢。所以在核心 DNS 系统之外，还有两种手段用来减轻域名解析的压力，并且能够更快地获取结果，基本思路就是“缓存”。首先，许多大公司、网络运行商都会建立自己的 DNS 服务器，作为用户 DNS 查询的代理，代替用户访问核心 DNS 系统。这些“野生”服务器被称为“非权威域名服务器”，可以缓存之前的查询结果，如果已经有了记录，就无需再向根服务器发起查询，直接返回对应的 IP 地址。</p> <p>这些 DNS 服务器的数量要比核心系统的服务器多很多，而且大多部署在离用户很近的地方。比较知名的 DNS 有 Google 的“8.8.8.8”，Microsoft 的“4.2.2.1”，还有 CloudFlare 的“1.1.1.1”等等。</p> <p>其次，操作系统里也会对 DNS 解析结果做缓存，如果你之前访问过“www.apple.com”，那么下一次在浏览器里再输入这个网址的时候就不会再跑到 DNS 那里去问了，直接在操作系统里就可以拿到 IP 地址。另外，操作系统里还有一个特殊的“主机映射”文件，通常是一个可编辑的文本，在 Linux 里是“/etc/hosts”，在 Windows 里是“C:\WINDOWS\system32\drivers\etc\hosts”，如果操作系统在缓存里找不到 DNS 记录，就会找这个文件。</p> <p>有了上面的“野生”DNS 服务器、操作系统缓存和 hosts 文件后，很多域名解析的工作就都不用“跋山涉水”了，直接在本地或本机就能解决，不仅方便了用户，也减轻了各级 DNS 服务器的压力，效率就大大提升了。</p> <p>下面的这张图比较完整地表示了现在的 DNS 架构。
<img src="https://static001.geekbang.org/resource/image/e5/ac/e51df3245609880641043af65bba94ac.png" alt=""></p> <h2 id="dns寻址"><a href="#dns寻址" class="header-anchor">#</a> DNS寻址</h2> <p>比如你有一个网站要上线，你在域名注册商那里申请了abc.com,那么你的域名A记录就保存在这个域名注册商的DNS服务器上，该DNS服务器称为权威域名服务器。</p> <h3 id="步骤"><a href="#步骤" class="header-anchor">#</a> 步骤</h3> <ol><li>当客户端访问abc.com时，先查找浏览器DNS缓存</li> <li>没有则查找操作系统DNS缓存，在这一阶段是操作系统dnscache clinet 服务进行DNS缓存的（你在任务管理器里面可以看到一个dns客户端进程，就是这玩意实现缓存的）</li> <li>如果还是没有则查找hosts文件中的域名记录</li> <li>然后依然没有的话则访问电脑上设置的DNS服务器IP，比如三大营运商的dns服务器或者谷歌的8.8.8.8，此时这一层的DNS服务器称为“野生DNS缓存服务器”，也就是非权威域名服务器</li> <li>如果还是没有则非权威域名服务器会去查找 根域名服务器-顶级域名服务器-二级域名服务器-权威域名服务器 ，这样客户端就在权威域名服务器上找到了abc.com对应的IP了，这个IP可以是多个，每次客户端请求的时候域名服务器会根据负载均衡算法分配一个IP给你。当DNS缓存失效了，则重新开始新一轮的域名请求</li></ol> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>浏览器缓存-&gt;操作系统dnscache -&gt;hosts文件-&gt;非权威域名服务器-&gt;根域名服务器-&gt;顶级域名服务器-&gt;二级域名服务器-&gt;权威域名服务器。</p> <p>其中非权威域名服务器还包括LDNS（企业内网DNS服务器），三大营运商DNS，谷歌公开的DNS，微软公开的DNS等。</p> <p>另外DNS请求有两种方式：递归查询和迭代查询。LDNS往后面查询一般是递归查询，因为公司内网是有防火墙的，全部请求通过LDNS来递归查询然后把结果给内网用户。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/12/2021, 3:24:37 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Network/Http/" class="prev">
        透析HTTP协议
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a2da8f38.js" defer></script><script src="/assets/js/2.d9c77588.js" defer></script><script src="/assets/js/21.cbdb3403.js" defer></script>
  </body>
</html>
