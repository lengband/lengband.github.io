<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>K8S | Lengband Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="即刻记录精彩">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.a2da8f38.js" as="script"><link rel="preload" href="/assets/js/2.d9c77588.js" as="script"><link rel="preload" href="/assets/js/25.1a2e3e5b.js" as="script"><link rel="prefetch" href="/assets/js/10.7bb7c324.js"><link rel="prefetch" href="/assets/js/11.48aafdf6.js"><link rel="prefetch" href="/assets/js/12.fe4beccc.js"><link rel="prefetch" href="/assets/js/13.a9830dd2.js"><link rel="prefetch" href="/assets/js/14.cc471259.js"><link rel="prefetch" href="/assets/js/15.80a888f9.js"><link rel="prefetch" href="/assets/js/16.9ef8bd1d.js"><link rel="prefetch" href="/assets/js/17.96a14a35.js"><link rel="prefetch" href="/assets/js/18.5b895c69.js"><link rel="prefetch" href="/assets/js/19.8a9d930e.js"><link rel="prefetch" href="/assets/js/20.06738571.js"><link rel="prefetch" href="/assets/js/21.cbdb3403.js"><link rel="prefetch" href="/assets/js/22.c694d42d.js"><link rel="prefetch" href="/assets/js/23.dc693082.js"><link rel="prefetch" href="/assets/js/24.0ccf1229.js"><link rel="prefetch" href="/assets/js/26.2bef024a.js"><link rel="prefetch" href="/assets/js/27.9ed68f2a.js"><link rel="prefetch" href="/assets/js/28.7d6e7e23.js"><link rel="prefetch" href="/assets/js/29.7bd115e9.js"><link rel="prefetch" href="/assets/js/3.dba46206.js"><link rel="prefetch" href="/assets/js/4.56bd36f2.js"><link rel="prefetch" href="/assets/js/5.0e979832.js"><link rel="prefetch" href="/assets/js/6.fb87b94e.js"><link rel="prefetch" href="/assets/js/7.73f2f48f.js"><link rel="prefetch" href="/assets/js/8.45fbd5fb.js"><link rel="prefetch" href="/assets/js/9.c26675c1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/hero.jpeg" alt="Lengband Blog" class="logo"> <span class="site-name can-hide">Lengband Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Fe/" class="nav-link">
  Web
</a></div><div class="nav-item"><a href="/Ops/" class="nav-link router-link-active">
  Ops
</a></div><div class="nav-item"><a href="/Network/" class="nav-link">
  Network
</a></div><div class="nav-item"><a href="/Thought/" class="nav-link">
  随笔
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Contact" class="dropdown-title"><span class="title">Contact</span> <span class="arrow down"></span></button> <button type="button" aria-label="Contact" class="mobile-dropdown-title"><span class="title">Contact</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/lengband" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Fe/" class="nav-link">
  Web
</a></div><div class="nav-item"><a href="/Ops/" class="nav-link router-link-active">
  Ops
</a></div><div class="nav-item"><a href="/Network/" class="nav-link">
  Network
</a></div><div class="nav-item"><a href="/Thought/" class="nav-link">
  随笔
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Contact" class="dropdown-title"><span class="title">Contact</span> <span class="arrow down"></span></button> <button type="button" aria-label="Contact" class="mobile-dropdown-title"><span class="title">Contact</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/lengband" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/Ops/docker/" class="sidebar-link">Docker</a></li><li><a href="/Ops/k8s/" aria-current="page" class="active sidebar-link">K8S</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Ops/k8s/#集群环境" class="sidebar-link">集群环境</a></li><li class="sidebar-sub-header"><a href="/Ops/k8s/#pod" class="sidebar-link">Pod</a></li><li class="sidebar-sub-header"><a href="/Ops/k8s/#namespace" class="sidebar-link">Namespace</a></li><li class="sidebar-sub-header"><a href="/Ops/k8s/#deployment" class="sidebar-link">Deployment</a></li><li class="sidebar-sub-header"><a href="/Ops/k8s/#replicaset" class="sidebar-link">Replicaset</a></li></ul></li><li><a href="/Ops/cert/" class="sidebar-link">Cert</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="集群环境"><a href="#集群环境" class="header-anchor">#</a> 集群环境</h2> <blockquote><p>快速搭建集群环境(仅可用4小时)</p></blockquote> <ol><li><p>https://labs.play-with-k8s.com/</p></li> <li><p><a href="https://github.com/kubernetes/minikube" target="_blank" rel="noopener noreferrer">Minikube<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>docker desktop 内置 (推荐)</p></li></ol> <h4 id="单纯使用容器-存在的问题"><a href="#单纯使用容器-存在的问题" class="header-anchor">#</a> 单纯使用容器，存在的问题</h4> <ul><li>怎么去管理这么多容器</li> <li>怎么能方便的横向扩展</li> <li>如果容器down了，怎么能自动恢复</li> <li>如果更新容器而不影响业务</li> <li>如何去监控追踪这些容器</li> <li>怎么去调度容器的创建</li> <li>保护隐私数据？</li></ul> <h3 id="kubelet"><a href="#kubelet" class="header-anchor">#</a> kubelet</h3> <p>相当于一个在node上的代理，管理容器相关。可以在node上面创建pod，创建pod里面的网络、volumns</p> <h3 id="kube-proxy"><a href="#kube-proxy" class="header-anchor">#</a> kube-proxy</h3> <p>主要负责容器上的网络代理，负载均衡的实现</p> <h3 id="kubectl"><a href="#kubectl" class="header-anchor">#</a> kubectl</h3> <p>客户端（命令行）与k8s交互的一个中介</p> <p><code>kubectl completion -h</code>
打开自动补全，以mac的zsh举例：<code>source &lt;(kubectl completion zsh)</code></p> <p>在本地访问远端的k8s集群:</p> <ol><li>把远端的K8S集群的配置放到本地，一般在 <code>~/.kube/config</code>，将里面的<code>cluster</code>、<code>context</code>和<code>user</code>的key-value复制过来，放在本地的<code>~/.kube/config</code>进行和原来的配置合并（注意<code>server-certificate-data和client-certificate-data</code>都是一行）</li> <li>执行<code>kubectl get contexts</code>应该能看到新加的context</li> <li>执行<code>kubectl config use-context &lt;context-name&gt;</code>切换到预期的context进行集群管理</li></ol> <p><code>kubectl get node</code> 查看node list
<code>kubectl get node -o wide</code> 查看node list 的详细信息（常用）
<code>kubectl get node -o yaml</code> 查看node list 的yaml 详细信息
<code>kubectl get node -o json</code> 查看node list 的json 详细信息
<code>kubectl get node --show-labels</code> 查看node list 的 label
<code>kubectl describe node &lt;node-name&gt;</code> 查看node的详情</p> <p>设置label
<code>kubectl label node &lt;node-name&gt; env=test</code> 给node设置label<code>env=test</code> <code>kubectl label node &lt;node-name&gt; env-</code> 给node删除label<code>env</code></p> <p>设置roles
<code>kubectl label node &lt;node-name&gt; node-role.kubernetes.io/master=</code> 设置master
<code>kubectl label node &lt;node-name&gt; node-role.kubernetes.io/worker=</code> 设置worker</p> <h2 id="pod"><a href="#pod" class="header-anchor">#</a> Pod</h2> <ul><li>一个或者一组应用容器，他们分享资源（比如volume）</li> <li>分享相同命名空间（如网络空间）的容器</li> <li>Pod是k8s最小的调度单位</li></ul> <h3 id="create-pod"><a href="#create-pod" class="header-anchor">#</a> create pod</h3> <p>create pod through yml file</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl create -f nginx_busybox.yml
pod <span class="token string">&quot;nginx-busybox&quot;</span> created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="get-pod-list"><a href="#get-pod-list" class="header-anchor">#</a> get pod list</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pods
NAME            READY     STATUS    RESTARTS   AGE
nginx-busybox   <span class="token number">2</span>/2       Running   <span class="token number">0</span>          57s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="get-pod-detail"><a href="#get-pod-detail" class="header-anchor">#</a> get pod detail</h3> <p>we use use describe or get pod with <code>-o</code> option to display more information about this pod</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl describe pod nginx-busybox
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pods nginx-busybox -o wide
NAME            READY     STATUS    RESTARTS   AGE       IP           NODE
nginx-busybox   <span class="token number">2</span>/2       Running   <span class="token number">0</span>          3m        <span class="token number">172.17</span>.0.4   minikube
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>here <code>-o</code> we can use <code>wide</code>, <code>json</code>, <code>yaml</code>, etc.</p> <h3 id="get-into-pod-container"><a href="#get-into-pod-container" class="header-anchor">#</a> get into pod(container)</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> nginx-busybox -it <span class="token function">sh</span>
Defaulting container name to nginx.
Use <span class="token string">'kubectl describe pod/nginx-busybox -n default'</span> to see all of the containers <span class="token keyword">in</span> this pod.
<span class="token comment">#</span>
<span class="token comment">#</span>
<span class="token comment">#</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="delete-pod"><a href="#delete-pod" class="header-anchor">#</a> delete pod</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete -f nginx_busybox.yml
pod <span class="token string">&quot;nginx-busybox&quot;</span> deleted
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="namespace"><a href="#namespace" class="header-anchor">#</a> Namespace</h2> <ul><li>Namespace命名空间用于不同的team，不同的project之间的隔离</li> <li>在不同的命名空间中，各种资源的名字是相互独立，比如可以具有相同名称的pod存在</li></ul> <h3 id="get-all-namesapce"><a href="#get-all-namesapce" class="header-anchor">#</a> get all namesapce</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get namespace
NAME          STATUS    AGE
default       Active    1d
kube-public   Active    1d
kube-system   Active    1d
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="create-namespace"><a href="#create-namespace" class="header-anchor">#</a> create namespace</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>% kubectl create namespace demo
namespace <span class="token string">&quot;demo&quot;</span> created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="delete-namespace"><a href="#delete-namespace" class="header-anchor">#</a> delete namespace</h3> <p>Please makesure there are no resources within this namespace you want to delete.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete namespace demo
namespace <span class="token string">&quot;demo&quot;</span> deleted
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="create-pod-with-namespace"><a href="#create-pod-with-namespace" class="header-anchor">#</a> create pod with namespace</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">more</span> nginx_namespace.yml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  namespace: demo
spec:
  containers:
  - name: nginx
    image: nginx
    ports:
    - containerPort: <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl create -f nginx_namespace.yml
Error from server <span class="token punctuation">(</span>NotFound<span class="token punctuation">)</span>: error when creating <span class="token string">&quot;nginx_namespace.yml&quot;</span><span class="token builtin class-name">:</span> namespaces <span class="token string">&quot;demo&quot;</span> not found
$ kubectl create namespace demo
namespace <span class="token string">&quot;demo&quot;</span> created
$ kubectl create -f nginx_namespace.yml
pod <span class="token string">&quot;nginx&quot;</span> created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="get-pod-with-namespace"><a href="#get-pod-with-namespace" class="header-anchor">#</a> get pod with namespace</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod --namespace demo
NAME      READY     STATUS    RESTARTS   AGE
nginx     <span class="token number">1</span>/1       Running   <span class="token number">0</span>          6m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="get-pod-with-all-namespace"><a href="#get-pod-with-all-namespace" class="header-anchor">#</a> get pod with all namespace</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod --all-namespaces
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="create-our-own-context"><a href="#create-our-own-context" class="header-anchor">#</a> create our own context</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl config set-context demo --user<span class="token operator">=</span>minikube --cluster<span class="token operator">=</span>minikube --namespace<span class="token operator">=</span>demo
Context <span class="token string">&quot;demo&quot;</span> created.
$ kubectl config get-contexts
CURRENT   NAME       CLUSTER    AUTHINFO   NAMESPACE
          demo       minikub    minikube   demo
          minikube   minikube   minikube
$ kubectl config use-context demo
Switched to context <span class="token string">&quot;demo&quot;</span><span class="token builtin class-name">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="deployment"><a href="#deployment" class="header-anchor">#</a> Deployment</h2> <h3 id="create-a-deployment"><a href="#create-a-deployment" class="header-anchor">#</a> Create a Deployment</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl create -f nginx_depolyment.yml
deployment.apps <span class="token string">&quot;nginx-deployment&quot;</span> created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="get-deployment"><a href="#get-deployment" class="header-anchor">#</a> Get deployment</h3> <p>Get deployment and pod information</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get deployment
NAME               DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   <span class="token number">2</span>         <span class="token number">2</span>         <span class="token number">2</span>            <span class="token number">2</span>           12s
$ kubectl get deployment -o wide
NAME               DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE       CONTAINERS   IMAGES        SELECTOR
nginx-deployment   <span class="token number">2</span>         <span class="token number">2</span>         <span class="token number">2</span>            <span class="token number">2</span>           40s       nginx        nginx:1.7.9   <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx
$ kubectl get pod -l <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx
NAME                                READY     STATUS    RESTARTS   AGE
nginx-deployment-75675f5897-bwz4j   <span class="token number">1</span>/1       Running   <span class="token number">0</span>          1m
nginx-deployment-75675f5897-z626w   <span class="token number">1</span>/1       Running   <span class="token number">0</span>          1m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>also can use describe</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl describe deployment nginx-deployment
Name:                   nginx-deployment
Namespace:              default
CreationTimestamp:      Tue, <span class="token number">26</span> Jun <span class="token number">2018</span> <span class="token number">23</span>:15:17 +0800
Labels:                 <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:            deployment.kubernetes.io/revision<span class="token operator">=</span><span class="token number">1</span>
Selector:               <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx
Replicas:               <span class="token number">2</span> desired <span class="token operator">|</span> <span class="token number">2</span> updated <span class="token operator">|</span> <span class="token number">2</span> total <span class="token operator">|</span> <span class="token number">2</span> available <span class="token operator">|</span> <span class="token number">0</span> unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        <span class="token number">0</span>
RollingUpdateStrategy:  <span class="token number">25</span>% max unavailable, <span class="token number">25</span>% max surge
Pod Template:
  Labels:  <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx
  Containers:
   nginx:
    Image:        nginx:1.7.9
    Port:         <span class="token number">80</span>/TCP
    Host Port:    <span class="token number">0</span>/TCP
    Environment:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
    Mounts:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
  Volumes:        <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
NewReplicaSet:   nginx-deployment-75675f5897 <span class="token punctuation">(</span><span class="token number">2</span>/2 replicas created<span class="token punctuation">)</span>
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  3m    deployment-controller  Scaled up replica <span class="token builtin class-name">set</span> nginx-deployment-75675f5897 to <span class="token number">2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="keep-desired-pod-state"><a href="#keep-desired-pod-state" class="header-anchor">#</a> keep desired pod state</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod -l <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx
NAME                                READY     STATUS    RESTARTS   AGE
nginx-deployment-75675f5897-bwz4j   <span class="token number">1</span>/1       Running   <span class="token number">0</span>          3m
nginx-deployment-75675f5897-z626w   <span class="token number">1</span>/1       Running   <span class="token number">0</span>          3m
$ kubectl delete pod nginx-deployment-75675f5897-bwz4j
pod <span class="token string">&quot;nginx-deployment-75675f5897-bwz4j&quot;</span> deleted
$ kubectl get pod -l <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx
NAME                                READY     STATUS    RESTARTS   AGE
nginx-deployment-75675f5897-6fdvh   <span class="token number">1</span>/1       Running   <span class="token number">0</span>          <span class="token operator">&lt;</span>invalid<span class="token operator">&gt;</span>
nginx-deployment-75675f5897-z626w   <span class="token number">1</span>/1       Running   <span class="token number">0</span>          4m
$ kubectl get pod -l <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx
NAME                                READY     STATUS    RESTARTS   AGE
nginx-deployment-75675f5897-6fdvh   <span class="token number">1</span>/1       Running   <span class="token number">0</span>          0s
nginx-deployment-75675f5897-z626w   <span class="token number">1</span>/1       Running   <span class="token number">0</span>          4m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="updating-the-deployment"><a href="#updating-the-deployment" class="header-anchor">#</a> Updating the deployment</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># for versions before 1.9.0 use apps/v1beta2</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span><span class="token number">1.8</span> <span class="token comment"># Update the version of nginx from 1.7.9 to 1.8</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply -f nginx_depolyment_update.yml
depolyment <span class="token string">&quot;nginx-deployment&quot;</span> updated
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="更新deployment-scaling-the-application-by-increasing-the-replica-count"><a href="#更新deployment-scaling-the-application-by-increasing-the-replica-count" class="header-anchor">#</a> 更新Deployment，Scaling the application by increasing the replica count</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply -f nginx_depolyment_scale.yml
depolyment <span class="token string">&quot;nginx-deployment&quot;</span> updated
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pods -l <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx
NAME                               READY     STATUS    RESTARTS   AGE
nginx-deployment-148880595-4zdqq   <span class="token number">1</span>/1       Running   <span class="token number">0</span>          25s
nginx-deployment-148880595-6zgi1   <span class="token number">1</span>/1       Running   <span class="token number">0</span>          25s
nginx-deployment-148880595-fxcez   <span class="token number">1</span>/1       Running   <span class="token number">0</span>          2m
nginx-deployment-148880595-rwovn   <span class="token number">1</span>/1       Running   <span class="token number">0</span>          2m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="只更新replication"><a href="#只更新replication" class="header-anchor">#</a> 只更新replication</h3> <p><em>执行后会有提示，安装提示更新相应的deployment</em></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl scale
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="只更新image或者env"><a href="#只更新image或者env" class="header-anchor">#</a> 只更新image或者env...</h3> <p><em>执行后会有提示，如更新镜像：<code>kubectl set image deployment/nginx-deployment nginx=nginx:1.9.1</code></em></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">set</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="delete-a-deployment"><a href="#delete-a-deployment" class="header-anchor">#</a> Delete a Deployment</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete deployment nginx-deployment
depolyment <span class="token string">&quot;nginx-deployment&quot;</span> deleted
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="replicaset"><a href="#replicaset" class="header-anchor">#</a> Replicaset</h2> <h3 id="create-deployment"><a href="#create-deployment" class="header-anchor">#</a> create deployment</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply -f nginx_deployment.yml
deployment.apps <span class="token string">&quot;nginx-deployment-test&quot;</span> created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>describe and get the relicaset event</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl describe deployment nginx-deployment-test
Name:                   nginx-deployment-test
Namespace:              default
CreationTimestamp:      Wed, <span class="token number">27</span> Jun <span class="token number">2018</span> 00:51:10 +0800
Labels:                 <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:            deployment.kubernetes.io/revision<span class="token operator">=</span><span class="token number">1</span>
                        kubectl.kubernetes.io/last-applied-configuration<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;apps/v1&quot;</span>,<span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Deployment&quot;</span>,<span class="token string">&quot;metadata&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;annotations&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;nginx-deployment-test&quot;</span>,<span class="token string">&quot;namespace&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;spec&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;replicas&quot;</span>:4,&quot;se<span class="token punctuation">..</span>.
Selector:               <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx
Replicas:               <span class="token number">4</span> desired <span class="token operator">|</span> <span class="token number">4</span> updated <span class="token operator">|</span> <span class="token number">4</span> total <span class="token operator">|</span> <span class="token number">4</span> available <span class="token operator">|</span> <span class="token number">0</span> unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        <span class="token number">0</span>
RollingUpdateStrategy:  <span class="token number">25</span>% max unavailable, <span class="token number">25</span>% max surge
Pod Template:
  Labels:  <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx
  Containers:
   nginx:
    Image:        nginx:1.7.9
    Port:         <span class="token number">80</span>/TCP
    Host Port:    <span class="token number">0</span>/TCP
    Environment:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
    Mounts:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
  Volumes:        <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
NewReplicaSet:   nginx-deployment-test-75675f5897 <span class="token punctuation">(</span><span class="token number">4</span>/4 replicas created<span class="token punctuation">)</span>
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  8h    deployment-controller  Scaled up replica <span class="token builtin class-name">set</span> nginx-deployment-test-75675f5897 to <span class="token number">4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="scale-and-check-the-replicaset-event"><a href="#scale-and-check-the-replicaset-event" class="header-anchor">#</a> scale and check the replicaset event</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl scale --current-replicas<span class="token operator">=</span><span class="token number">4</span> --replicas<span class="token operator">=</span><span class="token number">6</span> deployment/nginx-deployment-test
deployment.extensions <span class="token string">&quot;nginx-deployment-test&quot;</span> scaled
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl describe deployment nginx-deployment-test
Name:                   nginx-deployment-test
Namespace:              default
CreationTimestamp:      Wed, <span class="token number">27</span> Jun <span class="token number">2018</span> 00:51:10 +0800
Labels:                 <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:            deployment.kubernetes.io/revision<span class="token operator">=</span><span class="token number">1</span>
                        kubectl.kubernetes.io/last-applied-configuration<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;apps/v1&quot;</span>,<span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Deployment&quot;</span>,<span class="token string">&quot;metadata&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;annotations&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;nginx-deployment-test&quot;</span>,<span class="token string">&quot;namespace&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;spec&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;replicas&quot;</span>:4,&quot;se<span class="token punctuation">..</span>.
Selector:               <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx
Replicas:               <span class="token number">6</span> desired <span class="token operator">|</span> <span class="token number">6</span> updated <span class="token operator">|</span> <span class="token number">6</span> total <span class="token operator">|</span> <span class="token number">6</span> available <span class="token operator">|</span> <span class="token number">0</span> unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        <span class="token number">0</span>
RollingUpdateStrategy:  <span class="token number">25</span>% max unavailable, <span class="token number">25</span>% max surge
Pod Template:
  Labels:  <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx
  Containers:
   nginx:
    Image:        nginx:1.7.9
    Port:         <span class="token number">80</span>/TCP
    Host Port:    <span class="token number">0</span>/TCP
    Environment:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
    Mounts:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
  Volumes:        <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Progressing    True    NewReplicaSetAvailable
  Available      True    MinimumReplicasAvailable
OldReplicaSets:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
NewReplicaSet:   nginx-deployment-test-75675f5897 <span class="token punctuation">(</span><span class="token number">6</span>/6 replicas created<span class="token punctuation">)</span>
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  8h    deployment-controller  Scaled up replica <span class="token builtin class-name">set</span> nginx-deployment-test-75675f5897 to <span class="token number">4</span>
  Normal  ScalingReplicaSet  8h    deployment-controller  Scaled up replica <span class="token builtin class-name">set</span> nginx-deployment-test-75675f5897 to <span class="token number">6</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="check-rollout-status"><a href="#check-rollout-status" class="header-anchor">#</a> check rollout status</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl rollout status deployment nginx-deployment-test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>rollout history</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl rollout <span class="token function">history</span> deployment nginx-deployment-test
deployments <span class="token string">&quot;nginx-deployment-test&quot;</span>
REVISION  CHANGE-CAUSE
<span class="token number">1</span>         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
<span class="token number">2</span>         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
$ kubectl rollout <span class="token function">history</span> deployment nginx-deployment-test --revision <span class="token number">2</span>
deployments <span class="token string">&quot;nginx-deployment-test&quot;</span> with revision <span class="token comment">#2</span>
Pod Template:
  Labels:	<span class="token assign-left variable">app</span><span class="token operator">=</span>nginx
	pod-template-hash<span class="token operator">=</span><span class="token number">703038527</span>
  Containers:
   nginx:
    Image:	nginx:1.9.1
    Port:	<span class="token number">80</span>/TCP
    Host Port:	<span class="token number">0</span>/TCP
    Environment:	<span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
    Mounts:	<span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
  Volumes:	<span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="rollout-undo"><a href="#rollout-undo" class="header-anchor">#</a> rollout undo</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl rollout undo deployment nginx-deployment-test
deployment.apps <span class="token string">&quot;nginx-deployment-test&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/30/2021, 11:53:38 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Ops/docker/" class="prev">
        Docker
      </a></span> <span class="next"><a href="/Ops/cert/">
        Cert
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a2da8f38.js" defer></script><script src="/assets/js/2.d9c77588.js" defer></script><script src="/assets/js/25.1a2e3e5b.js" defer></script>
  </body>
</html>
